name: "ðŸ“ Gemini Release Notes"

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  release-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare context
        id: ctx
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ github.ref_name }}"
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          set -euo pipefail

          TAG="${TAG_NAME}"
          git fetch --tags --prune --force >/dev/null 2>&1 || true

          # Try to get previous released tag (from Releases). Fallback to previous git tag reachable from current.
          PREV_RELEASE_TAG="$(gh release list --limit 100 --json tagName --jq 'map(.tagName) | map(select(. != env.TAG)) | .[0]' || true)"
          if [[ -z "${PREV_RELEASE_TAG}" || "${PREV_RELEASE_TAG}" == "null" ]]; then
            PREV_RELEASE_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          fi

          BASE_RANGE=""
          COMPARE_URL=""
          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            BASE_RANGE="${PREV_RELEASE_TAG}..${TAG}"
            COMPARE_URL="https://github.com/${REPOSITORY}/compare/${PREV_RELEASE_TAG}...${TAG}"
          else
            # Initial release: include history up to the tag commit
            BASE_RANGE="${TAG}"
          fi

          # Collect data (trim to keep prompt concise)
          COMMITS="$(git log --no-merges --pretty=format:'- %s (%h) by %an' ${BASE_RANGE} | head -n 300 || true)"
          CHANGED_FILES="$( ( [[ -n "${PREV_RELEASE_TAG}" ]] && git diff --name-only ${BASE_RANGE} || git ls-tree -r --name-only HEAD ) | sed 's/^/- /' | head -n 500 || true)"
          CONTRIBUTORS="$(git log --format='%an' ${BASE_RANGE} | sort -u | sed 's/^/- /' | head -n 200 || true)"

          {
            echo "tag=${TAG}"
            echo "prev_tag=${PREV_RELEASE_TAG}"
            echo "compare_url=${COMPARE_URL}"
            echo 'commits<<EOF'
            echo "${COMMITS}"
            echo 'EOF'
            echo 'files<<EOF'
            echo "${CHANGED_FILES}"
            echo 'EOF'
            echo 'contributors<<EOF'
            echo "${CONTRIBUTORS}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Generate release notes with Gemini
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ steps.ctx.outputs.tag }}"
          PREV_TAG: "${{ steps.ctx.outputs.prev_tag }}"
          COMPARE_URL: "${{ steps.ctx.outputs.compare_url }}"
          COMMITS: "${{ steps.ctx.outputs.commits }}"
          CHANGED_FILES: "${{ steps.ctx.outputs.files }}"
          CONTRIBUTORS: "${{ steps.ctx.outputs.contributors }}"
        with:
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gcp_workload_identity_provider: "${{ vars.GCP_WIF_PROVIDER }}"
          gcp_project_id: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          gcp_location: "${{ vars.GOOGLE_CLOUD_LOCATION }}"
          gcp_service_account: "${{ vars.SERVICE_ACCOUNT_EMAIL }}"
          use_vertex_ai: "${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}"
          use_gemini_code_assist: "${{ vars.GOOGLE_GENAI_USE_GCA }}"
          settings: |
            { "debug": false, "maxSessionTurns": 10, "telemetry": { "enabled": false, "target": "gcp" } }
          prompt: |
            ã‚ãªãŸã¯ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆä½œæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‹ã‚‰ã€æ—¥æœ¬èªžã§èª­ã¿ã‚„ã™ã„Markdownã®ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            - ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.tag }}
            - å‰ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.prev_tag }}
            - æ¯”è¼ƒURL: ${{ steps.ctx.outputs.compare_url }}

            # å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.commits }}

            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.files }}

            # ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼ï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.contributors }}

            # åŸ·ç­†æ–¹é‡
            - è¦‹å‡ºã—ã¨ç®‡æ¡æ›¸ãã‚’ç”¨ã„ã¦ç°¡æ½”ã«ã€‚
            - ä¸»ãªå¤‰æ›´ç‚¹(Highlights)ã€Breaking Changesï¼ˆã‚ã‚Œã°ï¼‰ã€æ”¹å–„ãƒ»ä¿®æ­£ã€è²¢çŒ®è€…ã®é †ã§ã¾ã¨ã‚ã‚‹ã€‚
            - å¯èƒ½ãªã‚‰Conventional Commitsã‚’æ‰‹æŽ›ã‹ã‚Šã«åˆ†é¡žï¼ˆfeat/fix/docs/chore/refactor/perf/test ç­‰ï¼‰ã€‚
            - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é‡å¤§å¤‰æ›´ã‚’æŽ¨æ¸¬ã§ãã‚‹å ´åˆã¯ã€ŒBreaking Changesã€ã«æ˜Žè¨˜ã€‚
            - æœ€å¾Œã«æ¯”è¼ƒURLã‚’è¨˜è¼‰ã€‚
            - å‡ºåŠ›ã¯Markdownã®ã¿ï¼ˆä½™è¨ˆãªå‰ç½®ãã‚„å¾Œæ›¸ãã€ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹ã¯ä¸è¦ï¼‰ã€‚

            # æœŸå¾…ã™ã‚‹Markdownã®æ§‹æˆä¾‹
            # ${{ steps.ctx.outputs.tag }} ï½žã“ã®ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®å†…å®¹ãŒåˆ†ã‹ã‚‹ã‚ˆã†ãªã‚¿ã‚¤ãƒˆãƒ«ï½ž
            ## âœ¨ Highlights
            - ä¸»è¦ãªå¤‰æ›´ç‚¹ã®è¦ç´„â€¦

            ## ðŸ’¥ Breaking Changes
            - é‡å¤§ãªå¤‰æ›´ç‚¹â€¦ï¼ˆãªã‘ã‚Œã°ã“ã®ç¯€ã¯çœç•¥å¯ï¼‰

            ## ðŸ›  å¤‰æ›´ä¸€è¦§
            - feat: â€¦
            - fix: â€¦
            - docs: â€¦
            - refactor: â€¦
            - chore: â€¦

            ## ðŸ‘¥ Contributors
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¸€è¦§ï¼ˆæŠœç²‹ï¼‰

            ---
            æ¯”è¼ƒ: ${{ steps.ctx.outputs.compare_url }}

      - name: Write notes to file
        run: |
          set -euo pipefail
          # Write without shell interpolation to avoid ${...} expansion issues
          cat > release_notes.md << 'EOF'
          ${{ steps.gemini.outputs.summary }}
          EOF
          echo "Wrote release_notes.md (size: $(wc -c < release_notes.md) bytes)"

      - name: Create or update GitHub Release
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          TAG: "${{ steps.ctx.outputs.tag }}"
        run: |
          set -euo pipefail
          if gh release view "${TAG}" >/dev/null 2>&1; then
            gh release edit "${TAG}" --notes-file release_notes.md
          else
            # Mark pre-releases automatically if tag contains pre-release identifiers
            PRERELEASE_FLAG=""
            if [[ "${TAG}" =~ -(alpha|beta|rc) ]]; then PRERELEASE_FLAG="--prerelease"; fi
            gh release create "${TAG}" --title "${TAG}" --notes-file release_notes.md ${PRERELEASE_FLAG}
          fi
